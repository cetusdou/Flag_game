<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>答题大师</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/compendium.css">
    <link rel="stylesheet" href="css/modal.css">
    
    <script src="./assets/libs/echarts.min.js"></script>
    <script src="./assets/libs/world.js"></script>
    <script src="./assets/libs/china.js"></script>
    
    <!-- html2canvas for share card generation -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    
    <!-- 工具模块（按顺序加载） -->
</head>
<body>

<div class="loading-screen" id="loading-screen">
    <div class="loader-spinner"></div>
    <p>正在装载数据...</p>
</div>

<div class="container active" id="view-landing">
    <h1>答题大师</h1>
    <p style="color:#aaa; margin-bottom:30px;">选择你感兴趣的挑战领域</p>
    
    <div class="landing-grid">
        <div class="landing-card world world-card" onclick="enterGameScope('world')">
            <img src="assets/libs/Look-earth-from-the-moon.jpg" alt="Earth" class="world-overlay-image">
            <h2>世界模式</h2>
            <p>探索全球地理知识<br>国旗识别 · 首都记忆 · 版图形状</p>
        </div>
        
        <div class="landing-card china china-card" onclick="enterGameScope('china')">
            <img src="assets/libs/VCG211537037714-GJY.jpg" alt="China" class="china-overlay-image">
            <h2>中国模式</h2>
            <p>挑战中国地理知识<br>车牌识别 · 城市路网</p>
        </div>
        
        <div class="landing-card f1 sports-card" onclick="enterGameScope('sports')">
            <img src="assets/libs/2025ferraricarright.avif" alt="Ferrari" class="sports-overlay-image">
            <h2>体育模式</h2>
            <p>考验你的体育知识<br>F1赛道 · 足球俱乐部</p>
        </div>
    </div>
    
    <div class="author-info">
        <p>@Cetus</p>
    </div>
</div>

<div class="container" id="view-menu">
    <div class="menu-header">
        <button class="icon-btn back-btn" onclick="handleBackBtn()">
            <span>‹</span> <span id="back-btn-text">返回</span>
        </button>
        <button class="icon-btn" onclick="showRank()">
            <span>🏆</span>
        </button>
    </div>

    <div class="menu-titles">
        <h1 id="menu-title">模式选择</h1>
        <p id="menu-subtitle">--</p>
    </div>

    <div class="grid-menu">
        <div id="btn-mode-1" class="game-card" onclick="startGame('mode_1')">
            <div class="card-icon" id="txt-mode-1-icon">📅</div>
            <div class="card-content">
                <b id="txt-mode-1-title">加载中</b>
                <small id="txt-mode-1-desc">...</small>
            </div>
            <span class="card-tag" id="txt-mode-1-count">20</span>
        </div>
        
        <div id="btn-mode-2" class="game-card" onclick="startGame('mode_2')">
            <div class="card-icon" id="txt-mode-2-icon">🧩</div>
            <div class="card-content">
                <b id="txt-mode-2-title">加载中</b>
                <small id="txt-mode-2-desc">...</small>
            </div>
            <span class="card-tag" id="txt-mode-2-count">30</span>
        </div>
        
        <div id="btn-mode-3" class="game-card" onclick="startGame('mode_3')">
            <div class="card-icon" id="txt-mode-3-icon">⚡</div>
            <div class="card-content">
                <b id="txt-mode-3-title">加载中</b>
                <small id="txt-mode-3-desc">...</small>
            </div>
            <span class="card-tag" id="txt-mode-3-count">50</span>
        </div>
        
        <div id="btn-mode-all" class="game-card" onclick="startGame('all')">
            <div class="card-icon" id="txt-mode-all-icon">🔒</div>
            <div class="card-content">
                <b id="txt-mode-all-title">敬请期待</b>
                <small id="txt-mode-all-desc">Coming Soon</small>
            </div>
            <span class="card-tag" id="txt-mode-all-count" style="display:none"></span>
        </div>
    </div>

    <button class="wide-card card-green" id="compendium-btn" onclick="openCompendium()" style="margin-top:10px;">
        <div class="wide-content">
            <span class="big-icon" style="font-size:1.5rem">📖</span>
            <div class="text-group">
                <b style="color:#ffffff">知识图鉴</b>
                <small style="color:#ffffff; opacity:0.8">查阅详细资料</small>
            </div>
        </div>
        <span class="arrow-icon" style="color:#0f3d28">→</span>
    </button>
    
    <button class="wide-card" id="pk-mode-btn" onclick="startGame('pk')" style="margin-top:10px; background:linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);">
        <div class="wide-content">
            <span class="big-icon" style="font-size:1.5rem">⚔️</span>
            <div class="text-group">
                <b style="color:#fff">PK模式</b>
                <small style="color:#fff; opacity:0.9">输入种子，同题PK</small>
            </div>
        </div>
        <span class="arrow-icon" style="color:#fff">→</span>
    </button>
</div>

<div class="container" id="view-game">
    <div class="menu-header">
        <button class="icon-btn back-btn" onclick="goHome()">
            <span>‹</span> <span>返回</span>
        </button>
    </div>
    <div class="header">
        <span id="game-mode-label">模式</span>
        <span>得分: <b id="score-display" style="color:#4CAF50">0</b> | 剩余: <b id="remaining-questions" style="color:#87CEEB">0</b></span>
        <span id="countdown-display" style="display:none; color:#FF6B6B; font-weight:bold; font-size:1.1rem;">15</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    
    <div class="flag-box">
        <img id="flag-img" class="flag-img" style="display:none" loading="lazy" onerror="this.style.display='none'">
        <div id="plate-display" class="license-plate" style="display:none"></div>
        <div id="city-display" class="city-name-large" style="display:none"></div>
    </div>
    
    <div id="question-type-badge" class="type-badge"></div>
    <div class="options-grid" id="options-area"></div>
    <div id="fill-answer-area" style="display:none; margin-bottom:15px;">
        <input type="text" id="fill-answer-input" placeholder="请输入城市名称" style="width:100%; padding:15px; border-radius:12px; border:2px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:#fff; font-size:16px; box-sizing:border-box;">
        <button class="menu-btn" id="submit-fill-answer" onclick="submitFillAnswer()" style="margin-top:10px; background:linear-gradient(135deg, #4CAF50 0%, #388E3C 100%); border:none; color:#fff;">提交答案</button>
    </div>
    <div id="answer-feedback"></div>
    
    <button class="menu-btn game-map-btn" style="margin-top:10px; display:none; color:#fff;" id="game-map-btn" onclick="if(window.currentQ) openMap(window.currentQ)">🗺️ 查看位置</button>
    <!-- 下一题按钮已移除，改为自动跳转 -->
</div>

<div class="container" id="view-result">
    <div class="menu-header">
        <button class="icon-btn back-btn" onclick="goHome()">
            <span>‹</span> <span>返回</span>
        </button>
    </div>
    <h1 id="result-title">🎉 挑战完成!</h1>
    <h2 id="result-score" style="font-size: 2.5rem; color:#4CAF50; margin: 20px 0;">0/0</h2>
    <p id="result-detail" style="color:#aaa; margin-bottom:30px;">...</p>
    <button class="action-btn btn-share" onclick="generateShareCard()" style="margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        生成分享卡片
    </button>
</div>

<!-- 分享卡片模态框 -->
<div class="modal-overlay" id="share-card-modal" onclick="closeShareCardModal(event)">
    <div class="share-card-modal-content" onclick="event.stopPropagation()">
        <button class="share-card-close" onclick="closeShareCardModal(event)">✕</button>
        <div id="share-card-preview-container" style="display: none;">
            <img id="share-card-image" alt="分享卡片" style="max-width: 100%; max-height: 80vh; border-radius: 12px; user-select: none;">
            <div style="text-align: center; margin-top: 15px; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                <p>长按图片保存或右键保存图片</p>
                <button class="action-btn btn-download-share" onclick="downloadShareCard()" style="margin-top: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    下载图片
                </button>
            </div>
        </div>
        <div id="share-card-loading" style="text-align: center; color: #ffffff; padding: 50px;">
            <div style="font-size: 24px; margin-bottom: 30px; font-weight: 600; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">正在生成分享卡片...</div>
            <div style="width: 60px; height: 60px; border: 5px solid rgba(255,255,255,0.2); border-top-color: rgba(255,255,255,0.9); border-radius: 50%; margin: 0 auto; animation: spin 1s linear infinite; box-shadow: 0 0 20px rgba(255,255,255,0.3);"></div>
        </div>
    </div>
</div>

<!-- 分享卡片（隐藏，用于生成图片） -->
<div id="share-card-container" style="position: absolute; left: -9999px; top: -9999px; width: 800px; height: 600px;">
    <div id="share-card" style="width: 800px; height: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 24px; padding: 50px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between; color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif; position: relative; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
        <!-- 装饰性背景元素 -->
        <div style="position: absolute; top: -100px; right: -100px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius: 50%;"></div>
        <div style="position: absolute; bottom: -80px; left: -80px; width: 250px; height: 250px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%;"></div>
        
        <!-- 顶部区域 -->
        <div style="text-align: center; position: relative; z-index: 1;">
            <h1 style="font-size: 52px; margin: 0 0 15px 0; font-weight: 800; text-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.2); letter-spacing: 2px;">答题大师</h1>
            <div id="share-card-mode" style="font-size: 26px; margin-bottom: 10px; opacity: 0.95; font-weight: 500; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">挑战完成</div>
        </div>
        
        <!-- 中间区域 - 分数显示 -->
        <div style="text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; z-index: 1;">
            <div id="share-card-score" style="font-size: 140px; font-weight: 900; margin: 10px 0; text-shadow: 0 6px 25px rgba(0,0,0,0.4), 0 0 40px rgba(255,255,255,0.15); letter-spacing: -2px; line-height: 1.1;">0/0</div>
            <div id="share-card-detail" style="font-size: 32px; opacity: 0.95; margin-top: 25px; font-weight: 600; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">正确率: 0%</div>
        </div>
        
        <!-- 底部区域 -->
        <div style="text-align: center; font-size: 20px; opacity: 0.85; margin-top: 20px; position: relative; z-index: 1;">
            <div id="share-card-date" style="font-weight: 500; text-shadow: 0 2px 6px rgba(0,0,0,0.2);"></div>
            <div style="margin-top: 12px; font-size: 18px; font-weight: 600; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">@cetus</div>
        </div>
    </div>
</div>

<div class="container" id="view-rank">
    <div class="menu-header">
        <button class="icon-btn back-btn" onclick="goHome()">
            <span>‹</span> <span>返回</span>
        </button>
    </div>
    <h2>🏆 历史成绩</h2>
    
    <!-- 标签页切换 -->
    <div class="rank-tabs">
        <button class="rank-tab active" data-tab="world" onclick="switchRankTab('world')">🌍 世界模式</button>
        <button class="rank-tab" data-tab="china" onclick="switchRankTab('china')">🇨🇳 中国模式</button>
        <button class="rank-tab" data-tab="sports" onclick="switchRankTab('sports')">⚽ 体育模式</button>
    </div>
    
    <!-- 记录列表容器 -->
    <div class="rank-content">
        <div id="rank-list-world" class="rank-list active"></div>
        <div id="rank-list-china" class="rank-list"></div>
        <div id="rank-list-sports" class="rank-list"></div>
    </div>
    
    <button class="menu-btn" style="background:#f44336; margin-top:10px;" onclick="clearRecords()">🗑️ 清空记录</button>
</div>

<div class="container" id="view-compendium">
    <div class="menu-header">
        <button class="icon-btn back-btn" onclick="goHome()">
            <span>‹</span> <span>返回</span>
        </button>
    </div>
    <h2>📖 知识图鉴</h2>
    <input type="text" class="search-bar" id="search-input" placeholder="🔍 搜索城市、国家或地区..." oninput="filterCompendium()">
    <div class="compendium-grid" id="compendium-grid"></div>
</div>

<div class="modal-overlay" id="info-modal" onclick="closeModal(event)">
    <div class="glass-card">
        <img src="" id="modal-img" class="flag-large" style="display:none">
        <div id="modal-plate" class="license-plate" style="display:none; margin-bottom:20px;"></div>
        
        <h2 id="modal-name">...</h2>
        <div id="modal-en-name" class="en-name">...</div>
        <div class="info-grid"></div>
        <div id="wiki-info-container" style="display:none;">
            <button id="wiki-toggle-btn" class="wiki-toggle-btn" onclick="toggleWikiInfo()">
                <span>更多信息 (from wiki)</span>
                <span class="wiki-arrow">▼</span>
            </button>
            <div id="wiki-info-content" class="wiki-info-content" style="display:none;"></div>
        </div>
        <div class="action-row">
            <button class="action-btn btn-close" onclick="closeModal(event)">关闭</button>
            <button class="action-btn btn-map" id="modal-map-btn">🗺️ 查看位置</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="map-modal">
    <div class="map-modal-content">
        <div class="map-header">
            <span id="map-title">位置地图</span>
            <button onclick="closeMap()" style="background:none;border:none;color:white;font-size:1.5rem;padding:0 10px;">✕</button>
        </div>
        <div id="echarts-map-container"></div>
    </div>
</div>

<!-- PK模式种子输入弹窗 -->
<div class="modal-overlay" id="pk-seed-modal" onclick="closePKSeedModal(event)">
    <div class="glass-card pk-seed-card" onclick="event.stopPropagation()">
        <div class="pk-icon">⚔️</div>
        <h2 style="margin-top: 10px; margin-bottom: 5px;">PK模式</h2>
        <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 20px;">与朋友输入相同的数字种子，挑战相同的题目！</p>
        
        <!-- 难度选择（仅体育模式显示） -->
        <div id="pk-difficulty-selector" style="display: none; margin-bottom: 15px;">
            <p style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-bottom: 10px;">选择难度：</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <button class="pk-difficulty-btn" data-difficulty="easy" onclick="selectPKDifficulty('easy')">简单</button>
                <button class="pk-difficulty-btn" data-difficulty="medium" onclick="selectPKDifficulty('medium')">中等</button>
                <button class="pk-difficulty-btn" data-difficulty="hard" onclick="selectPKDifficulty('hard')">困难</button>
                <button class="pk-difficulty-btn" data-difficulty="hell" onclick="selectPKDifficulty('hell')">地狱</button>
            </div>
        </div>
        
        <input type="number" id="pk-seed-input" class="pk-seed-input" placeholder="请输入数字种子..." autofocus>
        <div class="pk-seed-hint">💡 提示：输入相同的数字种子，即可与朋友进行同题PK</div>
        <div class="action-row" style="margin-top: 20px;">
            <button class="action-btn btn-close" onclick="closePKSeedModal(event)">取消</button>
            <button class="action-btn btn-pk-confirm" onclick="confirmPKSeed()">开始PK</button>
        </div>
    </div>
</div>

<!-- 错误提示弹窗 -->
<!-- 图片放大模态框 -->
<div class="modal-overlay" id="image-zoom-modal" onclick="closeImageZoom(event)">
    <div class="image-zoom-content" onclick="event.stopPropagation()">
        <button class="image-zoom-close" onclick="closeImageZoom(event)">✕</button>
        <img id="zoomed-image" src="" alt="放大图片">
    </div>
</div>

<div class="modal-overlay" id="error-modal" onclick="closeErrorModal(event)">
    <div class="glass-card error-card" onclick="event.stopPropagation()">
        <div class="error-icon">⚠️</div>
        <h2 style="margin-top: 10px; margin-bottom: 15px;">提示信息</h2>
        <p id="error-message" style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 20px;"></p>
        <button class="action-btn btn-pk-confirm" onclick="closeErrorModal(event)" style="width: 100%;">确定</button>
    </div>
</div>

    <!-- 模块化脚本文件 -->
    <script src="js/data-manager.js"></script>
    <script src="js/game-state.js"></script>
    <script src="js/random-utils.js"></script>
    <script src="js/text-utils.js"></script>
    <script src="js/image-mask-utils.js"></script>
    <script src="js/button-config.js"></script>
    <script src="js/button-renderer.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/touch-gesture.js"></script>
    <script src="js/option-generator.js"></script>
    <script src="js/game-engine.js"></script>
    <script src="js/compendium.js"></script>
    <script src="js/map-handler.js"></script>
    <script src="js/leaderboard.js"></script>
    <script src="js/modal-handler.js"></script>
    <script src="js/share-card.js"></script>
    <script src="script.js"></script>
    <script src="js/main.js"></script>

</body>
</html>