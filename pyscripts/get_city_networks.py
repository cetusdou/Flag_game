import requests
from PIL import Image, ImageEnhance, ImageOps
from io import BytesIO
import math
import os
import json
import time

# --- âš™ï¸ é…ç½® ---
IMG_DIR = "./assets/city_networks"
DATA_DIR = "./data"
os.makedirs(IMG_DIR, exist_ok=True)
os.makedirs(DATA_DIR, exist_ok=True)

# ğŸ‡¨ğŸ‡³ åˆ†çœåœ°çº§å¸‚æ•°æ®æº (çœä»½ -> [ID, ä¸­æ–‡å, çº¬åº¦, ç»åº¦, ç¼©æ”¾])
# ç¼©æ”¾: 12=è¶…å¤§åŸå¸‚, 13=æ™®é€šåœ°çº§å¸‚
DATA_SOURCE = {
    "ç›´è¾–å¸‚": [
        ("beijing", "åŒ—äº¬", 39.9042, 116.4074, 12),
        ("shanghai", "ä¸Šæµ·", 31.2304, 121.4737, 12),
        ("tianjin", "å¤©æ´¥", 39.0842, 117.2009, 12),
        ("chongqing", "é‡åº†", 29.5630, 106.5516, 13),
    ],
    "ç‰¹åˆ«è¡Œæ”¿åŒº": [
        ("hong_kong", "é¦™æ¸¯", 22.3193, 114.1694, 13),
        ("macau", "æ¾³é—¨", 22.1987, 113.5439, 14),
    ],
    "æ²³åŒ—çœ": [
        ("shijiazhuang", "çŸ³å®¶åº„", 38.0428, 114.5149, 12),
        ("tangshan", "å”å±±", 39.6301, 118.1802, 13),
        ("qinhuangdao", "ç§¦çš‡å²›", 39.9617, 119.6005, 13),
        ("handan", "é‚¯éƒ¸", 36.6256, 114.5391, 13),
        ("baoding", "ä¿å®š", 38.8738, 115.4648, 13),
        ("zhangjiakou", "å¼ å®¶å£", 40.8183, 114.8859, 13),
        ("chengde", "æ‰¿å¾·", 40.9762, 117.9624, 13),
        ("cangzhou", "æ²§å·", 38.3045, 116.8388, 13),
        ("langfang", "å»ŠåŠ", 39.5380, 116.6837, 13),
        ("hengshui", "è¡¡æ°´", 37.7390, 115.6744, 13),
    ],
    "å±±è¥¿çœ": [
        ("taiyuan", "å¤ªåŸ", 37.8706, 112.5489, 12),
        ("datong", "å¤§åŒ", 40.0768, 113.3001, 13),
        ("yuncheng", "è¿åŸ", 35.0264, 111.0073, 13),
        ("linfen", "ä¸´æ±¾", 36.0880, 111.5189, 13),
        ("changzhi", "é•¿æ²»", 36.1954, 113.1163, 13),
    ],
    "å†…è’™å¤è‡ªæ²»åŒº": [
        ("hohhot", "å‘¼å’Œæµ©ç‰¹", 40.8415, 111.7492, 12),
        ("baotou", "åŒ…å¤´", 40.6579, 109.8404, 13),
        ("ordos", "é„‚å°”å¤šæ–¯", 39.6083, 109.7816, 13),
        ("chifeng", "èµ¤å³°", 42.2578, 118.9636, 13),
        ("tongliao", "é€šè¾½", 43.6137, 122.2433, 13),
        ("hulunbuir", "å‘¼ä¼¦è´å°”", 49.2116, 119.7658, 13),
    ],
    "è¾½å®çœ": [
        ("shenyang", "æ²ˆé˜³", 41.8057, 123.4315, 12),
        ("dalian", "å¤§è¿", 38.9140, 121.6147, 13),
        ("anshan", "éå±±", 41.1075, 122.9944, 13),
        ("fushun", "æŠšé¡º", 41.8655, 123.9572, 13),
        ("benxi", "æœ¬æºª", 41.3005, 123.7716, 13),
        ("dandong", "ä¸¹ä¸œ", 40.1242, 124.3830, 13),
        ("jinzhou", "é”¦å·", 41.0951, 121.1270, 13),
        ("yingkou", "è¥å£", 40.6674, 122.2319, 13),
    ],
    "å‰æ—çœ": [
        ("changchun", "é•¿æ˜¥", 43.8171, 125.3235, 12),
        ("jilin", "å‰æ—å¸‚", 43.8378, 126.5496, 13),
        ("siping", "å››å¹³", 43.1664, 124.3504, 13),
        ("yanbian", "å»¶è¾¹(å»¶å‰)", 42.9068, 129.5076, 13), # å·åºœæ‰€åœ¨åœ°
    ],
    "é»‘é¾™æ±Ÿçœ": [
        ("harbin", "å“ˆå°”æ»¨", 45.8038, 126.5350, 12),
        ("daqing", "å¤§åº†", 46.5845, 125.1037, 13),
        ("qiqihar", "é½é½å“ˆå°”", 47.3543, 123.9182, 13),
        ("mudanjiang", "ç‰¡ä¸¹æ±Ÿ", 44.5768, 129.6331, 13),
        ("jiamusi", "ä½³æœ¨æ–¯", 46.8021, 130.3189, 13),
        ("heihe", "é»‘æ²³", 50.2443, 127.5276, 14),
    ],
    "æ±Ÿè‹çœ": [
        ("nanjing", "å—äº¬", 32.0603, 118.7969, 12),
        ("suzhou", "è‹å·", 31.2989, 120.5853, 13),
        ("wuxi", "æ— é”¡", 31.4912, 120.3119, 13),
        ("xuzhou", "å¾å·", 34.2048, 117.2841, 13),
        ("changzhou", "å¸¸å·", 31.8112, 119.9741, 13),
        ("nantong", "å—é€š", 31.9802, 120.8943, 13),
        ("lianyungang", "è¿äº‘æ¸¯", 34.5967, 119.2215, 13),
        ("huai_an", "æ·®å®‰", 33.6104, 119.0153, 13),
        ("yancheng", "ç›åŸ", 33.3474, 120.1636, 13),
        ("yangzhou", "æ‰¬å·", 32.3942, 119.4129, 13),
        ("zhenjiang", "é•‡æ±Ÿ", 32.1878, 119.4252, 13),
        ("taizhou_js", "æ³°å·", 32.4555, 119.9246, 13),
        ("suqian", "å®¿è¿", 33.9630, 118.2752, 13),
    ],
    "æµ™æ±Ÿçœ": [
        ("hangzhou", "æ­å·", 30.2741, 120.1551, 12),
        ("ningbo", "å®æ³¢", 29.8683, 121.5440, 12),
        ("wenzhou", "æ¸©å·", 27.9943, 120.6994, 13),
        ("jiaxing", "å˜‰å…´", 30.7539, 120.7522, 13),
        ("huzhou", "æ¹–å·", 30.8930, 120.0873, 13),
        ("shaoxing", "ç»å…´", 30.0024, 120.5861, 13),
        ("jinhua", "é‡‘å", 29.0790, 119.6474, 13),
        ("quzhou", "è¡¢å·", 28.9701, 118.8593, 13),
        ("zhoushan", "èˆŸå±±", 29.9855, 122.2066, 13),
        ("taizhou_zj", "å°å·", 28.6564, 121.4208, 13),
        ("lishui", "ä¸½æ°´", 28.4676, 119.9218, 13),
    ],
    "å®‰å¾½çœ": [
        ("hefei", "åˆè‚¥", 31.8206, 117.2272, 12),
        ("wuhu", "èŠœæ¹–", 31.3528, 118.3755, 13),
        ("bengbu", "èšŒåŸ ", 32.9163, 117.3897, 13),
        ("huainan", "æ·®å—", 32.6255, 116.9965, 13),
        ("maanshan", "é©¬éå±±", 31.6700, 118.5067, 13),
        ("anqing", "å®‰åº†", 30.5248, 117.0428, 13),
        ("huangshan", "é»„å±±", 29.7147, 118.3375, 13),
        ("fuyang", "é˜œé˜³", 32.8901, 115.8142, 13),
    ],
    "ç¦å»ºçœ": [
        ("fuzhou", "ç¦å·", 26.0745, 119.2965, 12),
        ("xiamen", "å¦é—¨", 24.4798, 118.0894, 13),
        ("putian", "è†ç”°", 25.4541, 119.0078, 13),
        ("sanming", "ä¸‰æ˜", 26.2634, 117.6386, 13),
        ("quanzhou", "æ³‰å·", 24.8741, 118.6757, 13),
        ("zhangzhou", "æ¼³å·", 24.5130, 117.6473, 13),
        ("nanping", "å—å¹³", 26.6375, 118.1777, 13),
        ("longyan", "é¾™å²©", 25.0916, 117.0298, 13),
        ("ningde", "å®å¾·", 26.6656, 119.5479, 13),
    ],
    "æ±Ÿè¥¿çœ": [
        ("nanchang", "å—æ˜Œ", 28.6820, 115.8579, 12),
        ("jingdezhen", "æ™¯å¾·é•‡", 29.2690, 117.1782, 13),
        ("jiujiang", "ä¹æ±Ÿ", 29.7051, 116.0019, 13),
        ("ganzhou", "èµ£å·", 25.8311, 114.9347, 13),
        ("yichun", "å®œæ˜¥", 27.8158, 114.3826, 13),
        ("shangrao", "ä¸Šé¥¶", 28.4548, 117.9436, 13),
    ],
    "å±±ä¸œçœ": [
        ("jinan", "æµå—", 36.6512, 117.1201, 12),
        ("qingdao", "é’å²›", 36.0671, 120.3826, 13),
        ("zibo", "æ·„åš", 36.8135, 118.0550, 13),
        ("zaozhuang", "æ£åº„", 34.8105, 117.3230, 13),
        ("dongying", "ä¸œè¥", 37.4341, 118.6747, 13),
        ("yantai", "çƒŸå°", 37.4638, 121.4479, 13),
        ("weifang", "æ½åŠ", 36.7072, 119.1617, 13),
        ("jining", "æµå®", 35.4149, 116.5872, 13),
        ("taian", "æ³°å®‰", 36.2002, 117.0877, 13),
        ("weihai", "å¨æµ·", 37.5130, 122.1204, 13),
        ("rizhao", "æ—¥ç…§", 35.4164, 119.5270, 13),
        ("linyi", "ä¸´æ²‚", 35.0518, 118.3119, 13),
        ("dezhou", "å¾·å·", 37.4340, 116.3574, 13),
        ("liaocheng", "èŠåŸ", 36.4567, 115.9855, 13),
        ("binzhou", "æ»¨å·", 37.3820, 117.9707, 13),
        ("heze", "èæ³½", 35.2338, 115.4807, 13),
    ],
    "æ²³å—çœ": [
        ("zhengzhou", "éƒ‘å·", 34.7466, 113.6253, 12),
        ("kaifeng", "å¼€å°", 34.7972, 114.3076, 13),
        ("luoyang", "æ´›é˜³", 34.6181, 112.4540, 13),
        ("anyang", "å®‰é˜³", 36.0975, 114.3925, 13),
        ("xinxiang", "æ–°ä¹¡", 35.3026, 113.9268, 13),
        ("jiaozuo", "ç„¦ä½œ", 35.2158, 113.2418, 13),
        ("xuchang", "è®¸æ˜Œ", 34.0355, 113.8526, 13),
        ("nanyang", "å—é˜³", 32.9908, 112.5283, 13),
        ("shangqiu", "å•†ä¸˜", 34.4134, 115.6563, 13),
        ("xinyang", "ä¿¡é˜³", 32.1469, 114.0912, 13),
        ("zhoukou", "å‘¨å£", 33.6251, 114.6973, 13),
    ],
    "æ¹–åŒ—çœ": [
        ("wuhan", "æ­¦æ±‰", 30.5928, 114.3055, 12),
        ("huangshi", "é»„çŸ³", 30.2007, 115.0441, 13),
        ("shiyan", "åå °", 32.6475, 110.7993, 13),
        ("yichang", "å®œæ˜Œ", 30.6920, 111.2865, 13),
        ("xiangyang", "è¥„é˜³", 32.0087, 112.1224, 13),
        ("jingmen", "è†é—¨", 31.0354, 112.1994, 13),
        ("jingzhou", "è†å·", 30.3323, 112.2354, 13),
        ("huanggang", "é»„å†ˆ", 30.4355, 114.8726, 13),
        ("xianning", "å’¸å®", 29.8414, 114.3225, 13),
        ("enshi", "æ©æ–½", 30.2728, 109.4869, 13), # å·
    ],
    "æ¹–å—çœ": [
        ("changsha", "é•¿æ²™", 28.2282, 112.9388, 12),
        ("zhuzhou", "æ ªæ´²", 27.8274, 113.1338, 13),
        ("xiangtan", "æ¹˜æ½­", 27.8297, 112.9440, 13),
        ("hengyang", "è¡¡é˜³", 26.8968, 112.5725, 13),
        ("shaoyang", "é‚µé˜³", 27.2389, 111.4693, 13),
        ("yueyang", "å²³é˜³", 29.3567, 113.1289, 13),
        ("changde", "å¸¸å¾·", 29.0317, 111.6985, 13),
        ("zhangjiajie", "å¼ å®¶ç•Œ", 29.1170, 110.4792, 14),
        ("yiyang", "ç›Šé˜³", 28.5880, 112.3550, 13),
        ("chenzhou", "éƒ´å·", 25.7705, 113.0145, 13),
        ("huaihua", "æ€€åŒ–", 27.5501, 109.9985, 13),
    ],
    "å¹¿ä¸œçœ": [
        ("guangzhou", "å¹¿å·", 23.1291, 113.2644, 12),
        ("shenzhen", "æ·±åœ³", 22.5431, 114.0579, 12),
        ("zhuhai", "ç æµ·", 22.2707, 113.5767, 13),
        ("shantou", "æ±•å¤´", 23.3517, 116.6787, 13),
        ("foshan", "ä½›å±±", 23.0215, 113.1214, 13),
        ("shaoguan", "éŸ¶å…³", 24.8104, 113.5975, 13),
        ("zhanjiang", "æ¹›æ±Ÿ", 21.2707, 110.3594, 13),
        ("maoming", "èŒ‚å", 21.6620, 110.9254, 13),
        ("zhaoqing", "è‚‡åº†", 23.0472, 112.4651, 13),
        ("huizhou", "æƒ å·", 23.1115, 114.4161, 13),
        ("meizhou", "æ¢…å·", 24.2886, 116.1228, 13),
        ("dongguan", "ä¸œè", 23.0205, 113.7518, 12),
        ("zhongshan", "ä¸­å±±", 22.5170, 113.3928, 13),
        ("jiangmen", "æ±Ÿé—¨", 22.5787, 113.0819, 13),
        ("yangjiang", "é˜³æ±Ÿ", 21.8569, 111.9827, 13),
        ("qingyuan", "æ¸…è¿œ", 23.6817, 113.0560, 13),
        ("chaozhou", "æ½®å·", 23.6669, 116.6300, 13),
        ("jieyang", "æ­é˜³", 23.5253, 116.3725, 13),
    ],
    "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº": [
        ("nanning", "å—å®", 22.8170, 108.3665, 12),
        ("liuzhou", "æŸ³å·", 24.3255, 109.4126, 13),
        ("guilin", "æ¡‚æ—", 25.2345, 110.1800, 13),
        ("wuzhou", "æ¢§å·", 23.4769, 111.2791, 13),
        ("beihai", "åŒ—æµ·", 21.4812, 109.1192, 13),
        ("fangchenggang", "é˜²åŸæ¸¯", 21.6865, 108.3538, 13),
        ("yulin_gx", "ç‰æ—", 22.6372, 110.1652, 13),
    ],
    "æµ·å—çœ": [
        ("haikou", "æµ·å£", 20.0440, 110.1999, 13),
        ("sanya", "ä¸‰äºš", 18.2528, 109.5120, 13),
        ("sansha", "ä¸‰æ²™(æ°¸å…´å²›)", 16.8377, 112.3386, 15),
        ("danzhou", "å„‹å·", 19.5225, 109.5768, 13),
    ],
    "å››å·çœ": [
        ("chengdu", "æˆéƒ½", 30.5728, 104.0668, 12),
        ("zigong", "è‡ªè´¡", 29.3392, 104.7784, 13),
        ("panzhihua", "æ”€æèŠ±", 26.5823, 101.7186, 13),
        ("luzhou", "æ³¸å·", 28.8724, 105.4404, 13),
        ("deyang", "å¾·é˜³", 31.1279, 104.3986, 13),
        ("mianyang", "ç»µé˜³", 31.4674, 104.7578, 13),
        ("guangyuan", "å¹¿å…ƒ", 32.4417, 105.8433, 13),
        ("suining", "é‚å®", 30.5328, 105.5929, 13),
        ("neijiang", "å†…æ±Ÿ", 29.5802, 105.0584, 13),
        ("leshan", "ä¹å±±", 29.5521, 103.7656, 13),
        ("nanchong", "å—å……", 30.7991, 106.0829, 13),
        ("yibin", "å®œå®¾", 28.7525, 104.6432, 13),
        ("dazhou", "è¾¾å·", 31.2096, 107.4680, 13),
        ("xichang", "è¥¿æ˜Œ(å‡‰å±±)", 27.8932, 102.2662, 13),
    ],
    "è´µå·çœ": [
        ("guiyang", "è´µé˜³", 26.6470, 106.6302, 13),
        ("liupanshui", "å…­ç›˜æ°´", 26.5926, 104.8302, 13),
        ("zunyi", "éµä¹‰", 27.7050, 106.9270, 13),
        ("anshun", "å®‰é¡º", 26.2530, 105.9462, 13),
        ("bijie", "æ¯•èŠ‚", 27.3019, 105.2863, 13),
        ("tongren", "é“œä»", 27.7172, 109.1899, 13),
    ],
    "äº‘å—çœ": [
        ("kunming", "æ˜†æ˜", 24.8801, 102.8329, 12),
        ("qujing", "æ›²é–", 25.4899, 103.7978, 13),
        ("yuxi", "ç‰æºª", 24.3520, 102.5439, 13),
        ("baoshan", "ä¿å±±", 25.1118, 99.1618, 13),
        ("lijiang", "ä¸½æ±Ÿ", 26.8550, 100.2277, 14),
        ("jinghong", "æ™¯æ´ª(è¥¿åŒç‰ˆçº³)", 22.0017, 100.7979, 14),
        ("dali", "å¤§ç†", 25.6065, 100.2676, 13),
        ("ruili", "ç‘ä¸½(å¾·å®)", 24.0125, 97.8519, 14),
        ("shangrila", "é¦™æ ¼é‡Œæ‹‰(è¿ªåº†)", 27.8288, 99.7072, 14),
    ],
    "è¥¿è—è‡ªæ²»åŒº": [
        ("lhasa", "æ‹‰è¨", 29.6525, 91.1721, 13),
        ("shigatse", "æ—¥å–€åˆ™", 29.2675, 88.8752, 14),
        ("nyingchi", "æ—èŠ", 29.6453, 94.3615, 14),
    ],
    "é™•è¥¿çœ": [
        ("xi_an", "è¥¿å®‰", 34.3416, 108.9398, 12),
        ("tongchuan", "é“œå·", 35.0807, 109.0892, 13),
        ("baoji", "å®é¸¡", 34.3619, 107.2373, 13),
        ("xianyang", "å’¸é˜³", 34.3296, 108.7089, 13),
        ("weinan", "æ¸­å—", 34.4994, 109.5089, 13),
        ("yanan", "å»¶å®‰", 36.5854, 109.4897, 14),
        ("hanzhong", "æ±‰ä¸­", 33.0676, 107.0236, 13),
        ("yulin_sx", "æ¦†æ—", 38.2853, 109.7347, 13),
        ("ankang", "å®‰åº·", 32.6847, 109.0292, 13),
    ],
    "ç”˜è‚ƒçœ": [
        ("lanzhou", "å…°å·", 36.0611, 103.8343, 12),
        ("jiayuguan", "å˜‰å³ªå…³", 39.7731, 98.2891, 14),
        ("tianshui", "å¤©æ°´", 34.5808, 105.7249, 13),
        ("wuwei", "æ­¦å¨", 37.9283, 102.6371, 13),
        ("zhangye", "å¼ æ–", 38.9259, 100.4498, 13),
        ("jiuquan", "é…’æ³‰", 39.7321, 98.4942, 13),
        ("qingyang", "åº†é˜³", 35.7383, 107.6326, 13),
    ],
    "é’æµ·çœ": [
        ("xining", "è¥¿å®", 36.6171, 101.7782, 13),
        ("haidong", "æµ·ä¸œ", 36.5029, 102.1033, 13),
        ("golmud", "æ ¼å°”æœ¨", 36.4023, 94.9032, 13),
    ],
    "å®å¤å›æ—è‡ªæ²»åŒº": [
        ("yinchuan", "é“¶å·", 38.4872, 106.2309, 12),
        ("shizuishan", "çŸ³å˜´å±±", 39.0131, 106.3830, 13),
        ("wuzhong", "å´å¿ ", 37.9975, 106.1982, 13),
        ("zhongwei", "ä¸­å«", 37.5136, 105.1896, 14),
    ],
    "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº": [
        ("urumqi", "ä¹Œé²æœ¨é½", 43.8256, 87.6168, 12),
        ("karamay", "å…‹æ‹‰ç›ä¾", 45.6032, 84.8694, 13),
        ("turpan", "åé²ç•ª", 42.9333, 89.1897, 14),
        ("hami", "å“ˆå¯†", 42.8185, 93.5151, 13),
        ("changji", "æ˜Œå‰", 44.0131, 87.3040, 13),
        ("korla", "åº“å°”å‹’", 41.7641, 86.1453, 13),
        ("aksu", "é˜¿å…‹è‹", 41.1687, 80.2606, 13),
        ("kashgar", "å–€ä»€", 39.4704, 75.9898, 14),
        ("hotan", "å’Œç”°", 37.1141, 79.9222, 13),
        ("yining", "ä¼Šå®", 43.9143, 81.3179, 13),
    ],
    "å°æ¹¾çœ": [
        ("taipei", "å°åŒ—", 25.0330, 121.5654, 13),
        ("kaohsiung", "é«˜é›„", 22.6273, 120.3014, 13),
        ("taichung", "å°ä¸­", 24.1477, 120.6736, 13),
        ("tainan", "å°å—", 22.9997, 120.2270, 13),
        ("hualien", "èŠ±è²", 23.9769, 121.6068, 13),
    ],
}

# CartoDB æº
TILE_URL = "https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png"

def latlon_to_tile(lat, lon, zoom):
    n = 2.0 ** zoom
    xtile = int((lon + 180.0) / 360.0 * n)
    ytile = int((1.0 - math.log(math.tan(math.radians(lat)) + (1 / math.cos(math.radians(lat)))) / math.pi) / 2.0 * n)
    return xtile, ytile

def process_image(img):
    img = img.convert("L")
    img = ImageEnhance.Contrast(img).enhance(5.0) 
    img = ImageEnhance.Brightness(img).enhance(1.6)
    img = ImageOps.colorize(img, black="black", white="white")
    return img

def download_merged_image(name_id, lat, lon, zoom):
    center_x, center_y = latlon_to_tile(lat, lon, zoom)
    range_offset = 1 
    tile_size = 256
    width = tile_size * (range_offset * 2 + 1)
    height = tile_size * (range_offset * 2 + 1)
    
    merged_img = Image.new('RGB', (width, height))
    
    print(f"ğŸ–¼ï¸ [{zoom}] æ‹¼å›¾: {name_id} ...", end="")
    has_error = False
    
    for dx in range(-range_offset, range_offset + 1):
        for dy in range(-range_offset, range_offset + 1):
            xtile = center_x + dx
            ytile = center_y + dy
            url = TILE_URL.format(z=zoom, x=xtile, y=ytile)
            
            success = False
            for attempt in range(3):
                try:
                    headers = {'User-Agent': 'Mozilla/5.0'}
                    r = requests.get(url, headers=headers, timeout=10)
                    if r.status_code == 200:
                        tile_img = Image.open(BytesIO(r.content))
                        px = (dx + range_offset) * tile_size
                        py = (dy + range_offset) * tile_size
                        merged_img.paste(tile_img, (px, py))
                        success = True
                        break
                except:
                    time.sleep(0.5)
            
            if not success:
                print("x", end="")
                has_error = True

    final_img = process_image(merged_img)
    save_path = f"{IMG_DIR}/{name_id}.png"
    final_img.save(save_path)
    if has_error: print(" âš ï¸ ç¼º")
    else: print(" âœ…")

# --- ä¸»ç¨‹åº ---
print(f"ğŸš€ å¯åŠ¨åœ°çº§å¸‚è·¯ç½‘æ„å»º (æŒ‰çœä»½æ•´ç†)...")

json_output = []

# éå†çœä»½å­—å…¸
for province, cities in DATA_SOURCE.items():
    print(f"\nğŸ“‚ å¤„ç†: {province} ({len(cities)} ä¸ªåŸå¸‚)")
    
    for item in cities:
        cid, name, lat, lon, zoom = item
        
        # 1. ä¸‹è½½é€»è¾‘
        if not os.path.exists(f"{IMG_DIR}/{cid}.png"):
            download_merged_image(cid, lat, lon, zoom)
        else:
            print(f"  â© å·²å­˜åœ¨: {name}")
            pass
            
        # 2. æ•°æ®é€»è¾‘ (å†™å…¥çœä»½ä¿¡æ¯)
        json_output.append({
            "id": cid,
            "name": name,
            "province": province, # ğŸ”¥ æ–°å¢çœä»½å­—æ®µ
            "img": f"./assets/city_networks/{cid}.png",
            "lat": lat,
            "lon": lon
        })

# ä¿å­˜
with open(f"{DATA_DIR}/china_city_networks.json", "w", encoding='utf-8') as f:
    json.dump(json_output, f, ensure_ascii=False, indent=2)

print(f"\nğŸ‰ æ•´ç†å®Œæˆï¼")
print(f"âœ… å…±æ”¶å½•: {len(json_output)} ä¸ªåœ°çº§åŠä»¥ä¸ŠåŸå¸‚")
print(f"âœ… æ¯ä¸ªåŸå¸‚å‡åŒ…å«ç»çº¬åº¦ (lat/lon) å’Œçœä»½ (province)")