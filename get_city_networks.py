import requests
from PIL import Image, ImageEnhance, ImageOps
from io import BytesIO
import math
import os
import json
import time

# --- âš™ï¸ é…ç½® ---
IMG_DIR = "./assets/city_networks"
DATA_DIR = "./data"
os.makedirs(IMG_DIR, exist_ok=True)
os.makedirs(DATA_DIR, exist_ok=True)

# ğŸ‡¨ğŸ‡³ 155 åŸç»ˆæåå• (ID, ä¸­æ–‡å, çº¬åº¦, ç»åº¦, ç¼©æ”¾)
# ç¼©æ”¾: 12=å¤§åŸå¸‚å…¨è²Œ, 13=ä¸­ç­‰åŸå¸‚/ç»†èŠ‚, 14=å°åŸ/ç‰¹è‰²çº¹ç†
targets = [
    # --- åŸæœ‰çš„ 100 ä¸ªåŸºç¡€ (ç›´è¾–/çœä¼š/å‰¯çœçº§/çƒ­é—¨) ---
    ("beijing", "åŒ—äº¬", 39.9042, 116.4074, 12),
    ("shanghai", "ä¸Šæµ·", 31.2304, 121.4737, 12),
    ("tianjin", "å¤©æ´¥", 39.0842, 117.2009, 12),
    ("chongqing", "é‡åº†", 29.5630, 106.5516, 13),
    ("hong_kong", "é¦™æ¸¯", 22.3193, 114.1694, 13),
    ("macau", "æ¾³é—¨", 22.1987, 113.5439, 14),
    ("taipei", "å°åŒ—", 25.0330, 121.5654, 13),
    ("guangzhou", "å¹¿å·", 23.1291, 113.2644, 12),
    ("shenzhen", "æ·±åœ³", 22.5431, 114.0579, 12),
    ("zhuhai", "ç æµ·", 22.2707, 113.5767, 13),
    ("foshan", "ä½›å±±", 23.0215, 113.1214, 13),
    ("dongguan", "ä¸œè", 23.0205, 113.7518, 12),
    ("shantou", "æ±•å¤´", 23.3517, 116.6787, 13),
    ("haikou", "æµ·å£", 20.0440, 110.1999, 13),
    ("sanya", "ä¸‰äºš", 18.2528, 109.5120, 13),
    ("nanning", "å—å®", 22.8170, 108.3665, 12),
    ("guilin", "æ¡‚æ—", 25.2345, 110.1800, 13),
    ("liuzhou", "æŸ³å·", 24.3255, 109.4126, 13),
    ("beihai", "åŒ—æµ·", 21.4812, 109.1192, 13),
    ("nanjing", "å—äº¬", 32.0603, 118.7969, 12),
    ("suzhou", "è‹å·", 31.2989, 120.5853, 13),
    ("wuxi", "æ— é”¡", 31.4912, 120.3119, 13),
    ("changzhou", "å¸¸å·", 31.8112, 119.9741, 13),
    ("yangzhou", "æ‰¬å·", 32.3942, 119.4129, 13),
    ("xuzhou", "å¾å·", 34.2048, 117.2841, 13),
    ("hangzhou", "æ­å·", 30.2741, 120.1551, 12),
    ("ningbo", "å®æ³¢", 29.8683, 121.5440, 12),
    ("wenzhou", "æ¸©å·", 27.9943, 120.6994, 13),
    ("shaoxing", "ç»å…´", 30.0024, 120.5861, 13),
    ("jinhua", "é‡‘å", 29.0790, 119.6474, 13),
    ("yiwu", "ä¹‰ä¹Œ", 29.3003, 120.0751, 13),
    ("hefei", "åˆè‚¥", 31.8206, 117.2272, 12),
    ("fuzhou", "ç¦å·", 26.0745, 119.2965, 12),
    ("xiamen", "å¦é—¨", 24.4798, 118.0894, 13),
    ("quanzhou", "æ³‰å·", 24.8741, 118.6757, 13),
    ("nanchang", "å—æ˜Œ", 28.6820, 115.8579, 12),
    ("jingdezhen", "æ™¯å¾·é•‡", 29.2690, 117.1782, 13),
    ("jinan", "æµå—", 36.6512, 117.1201, 12),
    ("qingdao", "é’å²›", 36.0671, 120.3826, 13),
    ("yantai", "çƒŸå°", 37.4638, 121.4479, 13),
    ("weifang", "æ½åŠ", 36.7072, 119.1617, 13),
    ("zibo", "æ·„åš", 36.8135, 118.0550, 13),
    ("kaohsiung", "é«˜é›„", 22.6273, 120.3014, 13),
    ("taichung", "å°ä¸­", 24.1477, 120.6736, 13),
    ("tainan", "å°å—", 22.9997, 120.2270, 13),
    ("wuhan", "æ­¦æ±‰", 30.5928, 114.3055, 12),
    ("yichang", "å®œæ˜Œ", 30.6920, 111.2865, 13),
    ("xiangyang", "è¥„é˜³", 32.0087, 112.1224, 13),
    ("changsha", "é•¿æ²™", 28.2282, 112.9388, 12),
    ("zhuzhou", "æ ªæ´²", 27.8274, 113.1338, 13),
    ("yueyang", "å²³é˜³", 29.3567, 113.1289, 13),
    ("zhangjiajie", "å¼ å®¶ç•Œ", 29.1170, 110.4792, 14),
    ("zhengzhou", "éƒ‘å·", 34.7466, 113.6253, 12),
    ("luoyang", "æ´›é˜³", 34.6181, 112.4540, 13),
    ("kaifeng", "å¼€å°", 34.7972, 114.3076, 13),
    ("shijiazhuang", "çŸ³å®¶åº„", 38.0428, 114.5149, 12),
    ("tangshan", "å”å±±", 39.6301, 118.1802, 13),
    ("qinhuangdao", "ç§¦çš‡å²›", 39.9617, 119.6005, 13),
    ("taiyuan", "å¤ªåŸ", 37.8706, 112.5489, 12),
    ("datong", "å¤§åŒ", 40.0768, 113.3001, 13),
    ("hohhot", "å‘¼å’Œæµ©ç‰¹", 40.8415, 111.7492, 12),
    ("baotou", "åŒ…å¤´", 40.6579, 109.8404, 13),
    ("shenyang", "æ²ˆé˜³", 41.8057, 123.4315, 12),
    ("dalian", "å¤§è¿", 38.9140, 121.6147, 13),
    ("changchun", "é•¿æ˜¥", 43.8171, 125.3235, 12),
    ("harbin", "å“ˆå°”æ»¨", 45.8038, 126.5350, 12),
    ("daqing", "å¤§åº†", 46.5845, 125.1037, 13),
    ("qiqihar", "é½é½å“ˆå°”", 47.3543, 123.9182, 13),
    ("jilin", "å‰æ—å¸‚", 43.8378, 126.5496, 13),
    ("chengdu", "æˆéƒ½", 30.5728, 104.0668, 12),
    ("leshan", "ä¹å±±", 29.5521, 103.7656, 13),
    ("kunming", "æ˜†æ˜", 24.8801, 102.8329, 12),
    ("dali", "å¤§ç†", 25.6065, 100.2676, 13),
    ("lijiang", "ä¸½æ±Ÿ", 26.8550, 100.2277, 14),
    ("jinghong", "æ™¯æ´ª(ç‰ˆçº³)", 22.0017, 100.7979, 14),
    ("guiyang", "è´µé˜³", 26.6470, 106.6302, 13),
    ("zunyi", "éµä¹‰", 27.7050, 106.9270, 13),
    ("lhasa", "æ‹‰è¨", 29.6525, 91.1721, 13),
    ("shigatse", "æ—¥å–€åˆ™", 29.2675, 88.8752, 14),
    ("xi_an", "è¥¿å®‰", 34.3416, 108.9398, 12),
    ("baoji", "å®é¸¡", 34.3619, 107.2373, 13),
    ("yanan", "å»¶å®‰", 36.5854, 109.4897, 14),
    ("lanzhou", "å…°å·", 36.0611, 103.8343, 12),
    ("dunhuang", "æ•¦ç…Œ", 40.1421, 94.6620, 14),
    ("xining", "è¥¿å®", 36.6171, 101.7782, 13),
    ("yinchuan", "é“¶å·", 38.4872, 106.2309, 12),
    ("zhongwei", "ä¸­å«", 37.5136, 105.1896, 14),
    ("urumqi", "ä¹Œé²æœ¨é½", 43.8256, 87.6168, 12),
    ("kashgar", "å–€ä»€", 39.4704, 75.9898, 14),
    ("turpan", "åé²ç•ª", 42.9333, 89.1897, 14),
    ("korla", "åº“å°”å‹’", 41.7641, 86.1453, 13),
    ("karamay", "å…‹æ‹‰ç›ä¾", 45.6032, 84.8694, 13),
    ("tekes", "ç‰¹å…‹æ–¯", 43.2146, 81.8412, 15),
    ("shihezi", "çŸ³æ²³å­", 44.3054, 86.0332, 13),

    # --- ğŸ”¥ æ–°å¢ 50+ åŸå¸‚ (åä¸œ/åå—/è¥¿å—/è¥¿åŒ—/ä¸œåŒ—) ---
    # æ±Ÿæµ™å¯Œåº¶åœ°
    ("jiaxing", "å˜‰å…´", 30.7539, 120.7522, 13), # å—æ¹–
    ("huzhou", "æ¹–å·", 30.8930, 120.0873, 13), # å¤ªæ¹–è¾¹
    ("taizhou_zj", "å°å·", 28.6564, 121.4208, 13),
    ("zhenjiang", "é•‡æ±Ÿ", 32.1878, 119.4252, 13), # é•¿æ±Ÿ
    ("taizhou_js", "æ³°å·", 32.4555, 119.9246, 13),
    ("nantong", "å—é€š", 31.9802, 120.8943, 13),
    ("wuhu", "èŠœæ¹–", 31.3528, 118.3755, 13),
    ("anqing", "å®‰åº†", 30.5248, 117.0428, 13),
    
    # å±±ä¸œå¤§æ±‰
    ("jining", "æµå®", 35.4149, 116.5872, 13),
    ("weihai", "å¨æµ·", 37.5130, 122.1204, 13), # æµ·æ»¨
    ("linyi", "ä¸´æ²‚", 35.0518, 118.3119, 13),
    
    # åå—/æ±Ÿè¥¿
    ("ganzhou", "èµ£å·", 25.8311, 114.9347, 13), # å®‹åŸ
    ("zhanjiang", "æ¹›æ±Ÿ", 21.2707, 110.3594, 13), # å†›æ¸¯
    ("huizhou", "æƒ å·", 23.1115, 114.4161, 13), # è¥¿æ¹–
    ("zhongshan", "ä¸­å±±", 22.5170, 113.3928, 13),
    ("jiangmen", "æ±Ÿé—¨", 22.5787, 113.0819, 13), # ä¾¨ä¹¡
    
    # åä¸­
    ("hengyang", "è¡¡é˜³", 26.8968, 112.5725, 13),
    ("changde", "å¸¸å¾·", 29.0317, 111.6985, 13), # æ¡ƒèŠ±æº
    ("jingzhou", "è†å·", 30.3323, 112.2354, 13), # å¤åŸå¢™
    ("shiyan", "åå °", 32.6475, 110.7993, 13), # è½¦åŸ
    
    # ååŒ—
    ("handan", "é‚¯éƒ¸", 36.6256, 114.5391, 13),
    ("baoding", "ä¿å®š", 38.8738, 115.4648, 13),
    ("zhangjiakou", "å¼ å®¶ç•Œ", 40.8183, 114.8859, 13), # å†¬å¥¥
    ("chengde", "æ‰¿å¾·", 40.9762, 117.9624, 13), # é¿æš‘å±±åº„
    ("ordos", "é„‚å°”å¤šæ–¯", 39.6083, 109.7816, 13), # åº·å·´ä»€é¬¼åŸ(è§„åˆ’æ•´é½)
    
    # ä¸œåŒ—
    ("anshan", "éå±±", 41.1075, 122.9944, 13), # é’¢éƒ½
    ("dandong", "ä¸¹ä¸œ", 40.1242, 124.3830, 13), # è¾¹å¢ƒ
    ("jinzhou", "é”¦å·", 41.0951, 121.1270, 13),
    ("yanji", "å»¶å‰", 42.9068, 129.5076, 13), # æœé²œæ—ç‰¹è‰²
    
    # è¥¿åŒ—
    ("xianyang", "å’¸é˜³", 34.3296, 108.7089, 13),
    ("yulin_sx", "æ¦†æ—", 38.2853, 109.7347, 13), # é™•åŒ—
    ("tianshui", "å¤©æ°´", 34.5808, 105.7249, 13), # éº¦ç§¯å±±
    ("jiuquan", "é…’æ³‰", 39.7321, 98.4942, 13), # å«æ˜Ÿ
    ("hami", "å“ˆå¯†", 42.8185, 93.5151, 13),
    ("aksu", "é˜¿å…‹è‹", 41.1687, 80.2606, 13),
    
    # è¥¿å—
    ("mianyang", "ç»µé˜³", 31.4674, 104.7578, 13), # ç§‘æŠ€åŸ
    ("yibin", "å®œå®¾", 28.7525, 104.6432, 13), # é…’éƒ½
    ("nanchong", "å—å……", 30.7991, 106.0829, 13),
    ("bijie", "æ¯•èŠ‚", 27.3019, 105.2863, 13),
    ("shangrila", "é¦™æ ¼é‡Œæ‹‰", 27.8288, 99.7072, 14), # ç‹¬å…‹å®—
    ("panzhihua", "æ”€æèŠ±", 26.5823, 101.7186, 13), # å±±è°·åŸå¸‚
    ("luzhou", "æ³¸å·", 28.8724, 105.4404, 13),
    ("deyang", "å¾·é˜³", 31.1279, 104.3986, 13),
    ("guangyuan", "å¹¿å…ƒ", 32.4417, 105.8433, 13),
    ("dazhou", "è¾¾å·", 31.2096, 107.4680, 13),
    ("liupanshui", "å…­ç›˜æ°´", 26.5926, 104.8302, 13), # å‡‰éƒ½
    ("anshun", "å®‰é¡º", 26.2530, 105.9462, 13), # é»„æœæ ‘
    ("tongren", "é“œä»", 27.7172, 109.1899, 13),
    ("qujing", "æ›²é–", 25.4899, 103.7978, 13),
    ("yuxi", "ç‰æºª", 24.3520, 102.5439, 13),
    ("hanzhong", "æ±‰ä¸­", 33.0676, 107.0236, 13),
    ("jiayuguan", "å˜‰å³ªå…³", 39.7731, 98.2891, 14), # å…³åŸ
    ("zhangye", "å¼ æ–", 38.9259, 100.4498, 13), # ä¸ƒå½©ä¸¹éœ
    ("hotan", "å’Œç”°", 37.1141, 79.9222, 13),
    ("yining", "ä¼Šå®", 43.9143, 81.3179, 13), # å¡å¤–æ±Ÿå—
    ("dezhou", "å¾·å·", 37.4340, 116.3574, 13),
]

# CartoDB Dark No-Labels æº
TILE_URL = "https://a.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png"

def latlon_to_tile(lat, lon, zoom):
    n = 2.0 ** zoom
    xtile = int((lon + 180.0) / 360.0 * n)
    ytile = int((1.0 - math.log(math.tan(math.radians(lat)) + (1 / math.cos(math.radians(lat)))) / math.pi) / 2.0 * n)
    return xtile, ytile

def process_image(img):
    img = img.convert("L")
    img = ImageEnhance.Contrast(img).enhance(5.0) 
    img = ImageEnhance.Brightness(img).enhance(1.6)
    img = ImageOps.colorize(img, black="black", white="white")
    return img

def download_merged_image(name_id, lat, lon, zoom):
    center_x, center_y = latlon_to_tile(lat, lon, zoom)
    range_offset = 1 
    tile_size = 256
    width = tile_size * (range_offset * 2 + 1)
    height = tile_size * (range_offset * 2 + 1)
    
    merged_img = Image.new('RGB', (width, height))
    
    print(f"ğŸ–¼ï¸ [{zoom}] æ‹¼å›¾: {name_id} ...", end="")
    
    has_error = False
    
    for dx in range(-range_offset, range_offset + 1):
        for dy in range(-range_offset, range_offset + 1):
            xtile = center_x + dx
            ytile = center_y + dy
            
            url = TILE_URL.format(z=zoom, x=xtile, y=ytile)
            
            # é‡è¯•æœºåˆ¶
            success = False
            for attempt in range(3):
                try:
                    headers = {'User-Agent': 'Mozilla/5.0'}
                    r = requests.get(url, headers=headers, timeout=10)
                    if r.status_code == 200:
                        tile_img = Image.open(BytesIO(r.content))
                        px = (dx + range_offset) * tile_size
                        py = (dy + range_offset) * tile_size
                        merged_img.paste(tile_img, (px, py))
                        success = True
                        break
                except:
                    time.sleep(0.5)
            
            if not success:
                print("x", end="")
                has_error = True

    final_img = process_image(merged_img)
    save_path = f"{IMG_DIR}/{name_id}.png"
    final_img.save(save_path)
    
    if has_error: print(" âš ï¸ ç¼º")
    else: print(" âœ…")

# --- ä¸»ç¨‹åº ---
print(f"ğŸš€ å¯åŠ¨ 155 åŸä¸­åè·¯ç½‘æ„å»º (å¢é‡ç‰ˆ)...")

json_data = []

for i, item in enumerate(targets):
    cid, name, lat, lon, zoom = item
    
    if os.path.exists(f"{IMG_DIR}/{cid}.png"):
        print(f"â© è·³è¿‡: {name}")
    else:
        download_merged_image(cid, lat, lon, zoom)
    
    json_data.append({
        "id": cid,
        "name": name,
        "img": f"./assets/city_networks/{cid}.png"
    })

# è¦†ç›–ä¿å­˜ json
with open(f"{DATA_DIR}/china_city_networks.json", "w", encoding='utf-8') as f:
    json.dump(json_data, f, ensure_ascii=False, indent=2)

print(f"\nğŸ‰ 155 åŸè·¯ç½‘å›¾å…¨éƒ¨å°±ç»ªï¼")
print(f"ğŸ“‚ æ•°æ®æ–‡ä»¶: {DATA_DIR}/china_city_networks.json")